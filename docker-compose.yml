# ============================================================
# Modified: See CHANGELOG.md for complete modification history
# Last Updated: 2025-11-02
# Modified By: jimyungkoh<aqaqeqeq0511@gmail.com>
# ============================================================

services:
  traefik:
    image: traefik:v3.1
    container_name: traefik
    env_file:
      - ./traefik/.env
    command:
      - --providers.docker=true
      - --providers.docker.exposedbydefault=false
      - --entrypoints.web.address=:80
      - --entrypoints.websecure.address=:443
      - --entrypoints.web.http.redirections.entryPoint.to=websecure
      - --entrypoints.web.http.redirections.entryPoint.scheme=https
      - --entrypoints.web.http.redirections.entryPoint.permanent=true
      - --certificatesresolvers.le.acme.storage=/etc/traefik/acme/acme.json
      - --certificatesresolvers.le.acme.dnschallenge.provider=cloudflare
      - --certificatesresolvers.le.acme.dnschallenge.delaybeforecheck=0
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./traefik/acme:/etc/traefik/acme
    restart: unless-stopped
    networks:
      - proxy

  trading-agents:
    build:
      context: ./TradingAgents
      dockerfile: Dockerfile
    image: tradingagents:production
    container_name: trading-agents
    env_file:
      - ./TradingAgents/.env
    environment:
      SKIP_TOKEN_AUTH: ${SKIP_TOKEN_AUTH:-false}
    volumes:
      - ./TradingAgents/assets:/app/assets:ro
      - ./TradingAgents/results:/app/results
    expose:
      - "8000"
    restart: unless-stopped
    command: uvicorn tradingagents.api.app:app --host 0.0.0.0 --port 8000
    networks:
      - default

  server:
    build:
      context: .
      dockerfile: server/Dockerfile
    image: tradingagents-server:production
    container_name: tradingagents-server
    depends_on:
      - trading-agents
    env_file:
      - ./server/.env
    environment:
      NODE_ENV: production
      PYTHON_SERVICE_URL: http://trading-agents:8000
      SKIP_TOKEN_AUTH: ${SKIP_TOKEN_AUTH:-false}
    expose:
      - "3001"
    restart: unless-stopped
    networks:
      - default

  web:
    build:
      context: .
      dockerfile: web/Dockerfile
    image: tradingagents-web:production
    container_name: tradingagents-web
    depends_on:
      - server
    env_file:
      - ./web/.env
    environment:
      NODE_ENV: production
      NEST_API_BASE: http://server:3001
      SKIP_TOKEN_AUTH: ${SKIP_TOKEN_AUTH:-false}
    restart: unless-stopped
    labels:
      - traefik.enable=true
      - traefik.http.routers.websecure.entrypoints=websecure
      - traefik.http.routers.websecure.rule=HostRegexp(`{host:.+}`)
      - traefik.http.routers.websecure.tls=true
      - traefik.http.routers.websecure.service=web
      - traefik.http.services.web.loadbalancer.server.port=3000
    networks:
      - default
      - proxy

networks:
  proxy:
    driver: bridge
